name: Debug Workflow

on:
  workflow_dispatch:
    inputs:
      debug_level:
        description: "Debug level (info, verbose, debug)"
        required: false
        default: "info"
        type: choice
        options:
          - info
          - verbose
          - debug

jobs:
  debug-environment:
    name: Debug GitHub Actions Environment
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Debug repository structure
        run: |
          echo "ğŸ” Current working directory: $(pwd)"
          echo ""
          echo "ğŸ“ Repository structure:"
          find . -type d -name ".git" -prune -o -type d -print | head -20
          echo ""
          echo "ğŸ“„ Root files:"
          ls -la
          echo ""
          echo "ğŸ“„ API directory:"
          if [ -d "./api" ]; then
            ls -la ./api/
            echo ""
            echo "ğŸ“„ API package.json exists:"
            [ -f "./api/package.json" ] && echo "âœ… Yes" || echo "âŒ No"
          else
            echo "âŒ API directory not found"
          fi

      - name: Debug Node.js environment
        run: |
          echo "ğŸŸ¢ Node.js version: $(node --version)"
          echo "ğŸ“¦ NPM version: $(npm --version)"
          echo "ğŸ”§ NPX version: $(npx --version)"

      - name: Debug API dependencies (if exists)
        run: |
          if [ -d "./api" ] && [ -f "./api/package.json" ]; then
            cd ./api
            echo "ğŸ“‹ Package.json scripts:"
            npm run
            echo ""
            echo "ğŸ“¦ Installing dependencies..."
            npm ci
            echo ""
            echo "ğŸ”§ Prisma version:"
            npx prisma --version || echo "âŒ Prisma not available"
            echo ""
            echo "ğŸ§ª Jest configuration:"
            [ -f "jest.config.js" ] && echo "âœ… jest.config.js found" || echo "âŒ jest.config.js not found"
          else
            echo "âŒ Cannot check API dependencies - directory or package.json missing"
          fi

      - name: Debug test files
        run: |
          if [ -d "./api" ]; then
            cd ./api
            echo "ğŸ§ª Test files found:"
            find . -name "*.spec.ts" -o -name "*.test.ts" | head -10
            echo ""
            echo "ğŸ“ Source structure:"
            find ./src -type d | head -10
          fi

      - name: Test simple commands
        run: |
          echo "ğŸ“ Testing basic commands..."
          echo "Current user: $(whoami)"
          echo "Current directory: $(pwd)"
          echo "Available space: $(df -h . | tail -1)"
          echo "Memory info: $(free -h | head -2)"

      - name: Verbose output (if requested)
        if: ${{ github.event.inputs.debug_level == 'verbose' || github.event.inputs.debug_level == 'debug' }}
        run: |
          echo "ğŸ” Verbose debugging..."
          echo "Environment variables:"
          env | grep -E "(GITHUB_|RUNNER_)" | sort
          echo ""
          echo "Path directories:"
          echo $PATH | tr ':' '\n'

      - name: Deep debug (if requested)
        if: ${{ github.event.inputs.debug_level == 'debug' }}
        run: |
          echo "ğŸ› Deep debugging..."
          echo "Process list:"
          ps aux | head -10
          echo ""
          echo "Network info:"
          ip addr show | head -10 || ifconfig | head -10
          echo ""
          echo "Disk usage:"
          du -sh ./* | sort -hr | head -10
